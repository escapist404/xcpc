枚举每个 $1 \le i \le n$，注意到仅当包含 $a_i$ 且其为最小值的极长子串贡献答案，原因是在扩展某个普通子串的过程中，新加入的元素不会让 $\mathrm{med}$ 变小。

考虑怎么求出这样的子串。将 $a_i$ 按从小到大的顺序从序列中删除，删除前后得到的若干连通块（子串）即为所求。

最后利用可持久化线段树维护中位数，以及常规方法维护最小值即可求答案。

每次删除至多产生 $2$ 个新的子串。